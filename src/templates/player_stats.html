<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f7fa; margin:0; padding:0; }
    header { background:#2563eb; color:white; padding:1rem; text-align:center; }
    h1 { margin:0; text-align:center; }
    #add-stats { text-align:center; margin:1rem; }
    #add-stats input, #add-stats select { padding:0.5rem; margin-right:0.5rem; width:90px; }
    button { padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; }
    button.update-btn { background:#facc15; color:black; }
    button.delete-btn { background:red; color:white; }
    table { border-collapse: collapse; width: 90%; margin:auto; margin-top:1rem; }
    th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
    th { background:#f2f2f2; }
    #update-form { display:none; text-align:center; margin-top:1rem; }
    #update-form input, #update-form select { padding:0.5rem; margin-right:0.5rem; width:90px; }
    #message { color:red; text-align:center; margin-top:0.5rem; }
  </style>
</head>
<body>

<header>
  <h1 id="player-name-header">Player Stats</h1>
</header>

<div id="add-stats">
  <select id="game-select"></select>
  <input type="number" id="touchdowns" placeholder="TDs" min="0"/>
  <input type="number" id="receptions" placeholder="Receptions" min="0"/>
  <input type="number" id="yards" placeholder="Yards" min="0"/>
  <input type="number" id="interceptions" placeholder="Ints" min="0"/>
  <input type="number" id="sacks" placeholder="Sacks" min="0"/>
  <input type="number" id="flags_pulled" placeholder="Flags" min="0"/>
  <button onclick="addStats()">Add Stats</button>
  <div id="message"></div>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Game</th>
      <th>TDs</th>
      <th>Receptions</th>
      <th>Yards</th>
      <th>Ints</th>
      <th>Sacks</th>
      <th>Flags</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="stats-body"></tbody>
</table>

<div id="update-form">
  <h3>Edit Stats</h3>
  <select id="edit-game-select"></select>
  <input type="number" id="edit-touchdowns" placeholder="TDs" min="0"/>
  <input type="number" id="edit-receptions" placeholder="Receptions" min="0"/>
  <input type="number" id="edit-yards" placeholder="Yards" min="0"/>
  <input type="number" id="edit-interceptions" placeholder="Ints" min="0"/>
  <input type="number" id="edit-sacks" placeholder="Sacks" min="0"/>
  <input type="number" id="edit-flags" placeholder="Flags" min="0"/>
  <button onclick="submitUpdate()">Save</button>
  <button onclick="cancelUpdate()">Cancel</button>
</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const messageEl = document.getElementById("message");
  let statsCache = [];
  let editingStatId = null;
  const playerId = new URLSearchParams(window.location.search).get('player_id');
  let playerTeamId = null;

  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.href = "login.html";
  }

  async function loadPlayerName() {
    const { data, error } = await supabase.from('players').select('name, team_id').eq('id', playerId).single();
    if (error) return messageEl.textContent = error.message;
    document.getElementById('player-name-header').textContent = data.name + ' Stats';
    playerTeamId = data.team_id;
    await loadGames();
  }

  async function loadGames() {
    if (!playerTeamId) return;
    const { data: games, error } = await supabase
      .from('games')
      .select('id, date, home_team_id, away_team_id')
      .or(`home_team_id.eq.${playerTeamId},away_team_id.eq.${playerTeamId}`)
      .order('date', { ascending: true });

    if (error) return messageEl.textContent = error.message;

    const select = document.getElementById('game-select');
    const editSelect = document.getElementById('edit-game-select');
    select.innerHTML = '';
    editSelect.innerHTML = '';

    for (const game of games) {
      const { data: home } = await supabase.from('teams').select('name').eq('id', game.home_team_id).single();
      const { data: away } = await supabase.from('teams').select('name').eq('id', game.away_team_id).single();

      const text = `${away?.name || 'Away'} @ ${home?.name || 'Home'} - ${game.date}`;

      const option = document.createElement('option');
      option.value = game.id;
      option.textContent = text;
      select.appendChild(option);

      const editOption = document.createElement('option');
      editOption.value = game.id;
      editOption.textContent = text;
      editSelect.appendChild(editOption);
    }
  }

  async function loadStats() {
    const { data, error } = await supabase
      .from('player_stats')
      .select('*, games(date, home_team_id, away_team_id)')
      .eq('player_id', playerId)
      .order('id', { ascending:true });
    if (error) return messageEl.textContent = error.message;

    statsCache = data;
    const tbody = document.getElementById("stats-body");
    tbody.innerHTML = "";
    for (const stat of data) {
      const { data: home } = await supabase.from('teams').select('name').eq('id', stat.games.home_team_id).single();
      const { data: away } = await supabase.from('teams').select('name').eq('id', stat.games.away_team_id).single();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stat.id}</td>
        <td>${away?.name || 'Away'} @ ${home?.name || 'Home'} - ${stat.games.date}</td>
        <td>${stat.touchdowns}</td>
        <td>${stat.receptions}</td>
        <td>${stat.yards}</td>
        <td>${stat.interceptions}</td>
        <td>${stat.sacks}</td>
        <td>${stat.flags_pulled}</td>
        <td>
          <button class="update-btn" onclick="editStats(${stat.id})">Edit</button>
          <button class="delete-btn" onclick="deleteStats(${stat.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function addStats() {
    const payload = {
      player_id: playerId,
      game_id: Number(document.getElementById('game-select').value),
      touchdowns: Number(document.getElementById('touchdowns').value) || 0,
      receptions: Number(document.getElementById('receptions').value) || 0,
      yards: Number(document.getElementById('yards').value) || 0,
      interceptions: Number(document.getElementById('interceptions').value) || 0,
      sacks: Number(document.getElementById('sacks').value) || 0,
      flags_pulled: Number(document.getElementById('flags_pulled').value) || 0
    };

    const { error } = await supabase.from('player_stats').insert([payload]);
    if (error) messageEl.textContent = error.message;
    else {
      document.getElementById('touchdowns').value = "";
      document.getElementById('receptions').value = "";
      document.getElementById('yards').value = "";
      document.getElementById('interceptions').value = "";
      document.getElementById('sacks').value = "";
      document.getElementById('flags_pulled').value = "";
      messageEl.textContent = "";
      loadStats();
    }
  }

  function editStats(id) {
    editingStatId = id;
    const stat = statsCache.find(s => s.id === id);
    document.getElementById('edit-game-select').value = stat.game_id;
    document.getElementById('edit-touchdowns').value = stat.touchdowns;
    document.getElementById('edit-receptions').value = stat.receptions;
    document.getElementById('edit-yards').value = stat.yards;
    document.getElementById('edit-interceptions').value = stat.interceptions;
    document.getElementById('edit-sacks').value = stat.sacks;
    document.getElementById('edit-flags').value = stat.flags_pulled;
    document.getElementById('update-form').style.display = "block";
    window.scrollTo(0, document.body.scrollHeight);
  }

  function cancelUpdate() {
    editingStatId = null;
    document.getElementById('update-form').style.display = "none";
  }

  async function submitUpdate() {
    if (!editingStatId) return;
    const payload = {
      game_id: Number(document.getElementById('edit-game-select').value),
      touchdowns: Number(document.getElementById('edit-touchdowns').value) || 0,
      receptions: Number(document.getElementById('edit-receptions').value) || 0,
      yards: Number(document.getElementById('edit-yards').value) || 0,
      interceptions: Number(document.getElementById('edit-interceptions').value) || 0,
      sacks: Number(document.getElementById('edit-sacks').value) || 0,
      flags_pulled: Number(document.getElementById('edit-flags').value) || 0
    };

    const { error } = await supabase.from('player_stats').update(payload).eq('id', editingStatId);
    if (error) alert(error.message);
    else {
      cancelUpdate();
      loadStats();
    }
  }

  async function deleteStats(id) {
    if (!confirm("Delete this stat entry?")) return;
    const { error } = await supabase.from('player_stats').delete().eq('id', id);
    if (error) alert(error.message);
    else loadStats();
  }

  window.addStats = addStats;
  window.editStats = editStats;
  window.cancelUpdate = cancelUpdate;
  window.submitUpdate = submitUpdate;
  window.deleteStats = deleteStats;

  checkAuth().then(() => {
    loadPlayerName().then(loadStats);
  });
</script>

</body>
</html>
