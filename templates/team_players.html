<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Team Players</title>
    <style>
        table { border-collapse: collapse; width: 80%; margin: auto; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        h1 { text-align: center; }
        #add-player-form { text-align: center; margin-bottom: 20px; }
        #add-player-form input { padding: 5px; margin-right: 5px; }
        button.delete-btn { color: white; background-color: red; border: none; padding: 4px 8px; cursor: pointer; }
    </style>
</head>
<body>

    <h1 id="team-title">Players</h1>

    <div id="add-player-form">
        <input type="text" id="player-name" placeholder="Player Name" required>
        <input type="text" id="player-position" placeholder="Position (optional)">
        <button onclick="addPlayer()">Add Player</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Position</th>
                <th>View Stats</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="players-body"></tbody>
    </table>

    <!-- Update form -->
    <div id="update-form" style="display:none; text-align:center; margin-top:20px;">
        <h3>Edit Player</h3>
        <input type="text" id="edit-name" placeholder="Name">
        <input type="text" id="edit-position" placeholder="Position (optional)">
        <button onclick="submitUpdate()">Save</button>
        <button onclick="cancelUpdate()">Cancel</button>
    </div>

    <script>
        let teamId = null;
        let teamName = "";
        let editingPlayerId = null;

        // Extract team_id from query string
        function getTeamId() {
            const params = new URLSearchParams(window.location.search);
            return params.get("team_id");
        }

        async function loadTeamName() {
            const res = await fetch(`/teams/${teamId}`);
            const team = await res.json();
            teamName = team.name;

            document.getElementById("team-title").textContent = `${team.name} Players`;
        }

        async function loadPlayers() {
            const res = await fetch(`/teams/${teamId}/players`);
            const players = await res.json();

            const tbody = document.getElementById("players-body");
            tbody.innerHTML = "";

            players.forEach(player => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${player.position || ""}</td>
                    <td><a href="player_stats_page?player_id=${player.id}">View Stats</a></td>
                    <td>
                        <button onclick="editPlayer(${player.id}, '${player.name}', '${player.position || ""}')">Update</button>
                        <button class="delete-btn" onclick="deletePlayer(${player.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function addPlayer() {
            const name = document.getElementById("player-name").value;
            const position = document.getElementById("player-position").value.trim();

            if (!name) return alert("Please enter a name.");

            const payload = { name, team_id: teamId };
            if (position !== "") payload.position = position;

            const res = await fetch("/players", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.getElementById("player-name").value = "";
                document.getElementById("player-position").value = "";
                loadPlayers();
            } else {
                alert("Error adding player.");
            }
        }

        async function deletePlayer(playerId) {
            if (!confirm("Delete this player?")) return;

            const res = await fetch(`/players/${playerId}`, { method: "DELETE" });

            if (res.ok) loadPlayers();
            else alert("Error deleting player.");
        }

        // Update player
        function editPlayer(id, name, position) {
            editingPlayerId = id;

            document.getElementById("edit-name").value = name;
            document.getElementById("edit-position").value = position || "";

            document.getElementById("update-form").style.display = "block";
            window.scrollTo(0, document.body.scrollHeight);
        }

        function cancelUpdate() {
            editingPlayerId = null;
            document.getElementById("update-form").style.display = "none";
        }

        async function submitUpdate() {
            if (!editingPlayerId) return;

            const name = document.getElementById("edit-name").value.trim();
            const position = document.getElementById("edit-position").value.trim();

            if (!name) return alert("Name cannot be empty.");

            const payload = { name, team_id: teamId };
            if (position !== "") payload.position = position;

            const res = await fetch(`/players/${editingPlayerId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                cancelUpdate();
                loadPlayers();
            } else {
                alert("Error updating player.");
            }
        }

        // Initialize page
        teamId = getTeamId();
        if (!teamId) {
            alert("No team_id provided in query.");
        } else {
            loadTeamName();
            loadPlayers();
        }
    </script>

</body>
</html>
