<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Combine Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f7fa; margin:0; padding:0; }
    header { background:#2563eb; color:white; padding:1rem; text-align:center; }
    h1 { margin:0; text-align:center; }
    #add-combine { text-align:center; margin:1rem; }
    #add-combine input { padding:0.5rem; margin-right:0.5rem; width:90px; }
    button { padding:0.4rem 0.8rem; border:none; border-radius:4px; cursor:pointer; }
    button.update-btn { background:#facc15; color:black; }
    button.delete-btn { background:red; color:white; }
    table { border-collapse: collapse; width: 90%; margin:auto; margin-top:1rem; }
    th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
    th { background:#f2f2f2; }
    #update-form { display:none; text-align:center; margin-top:1rem; }
    #update-form input { padding:0.5rem; margin-right:0.5rem; width:90px; }
    #message { color:red; text-align:center; margin-top:0.5rem; }
  </style>
</head>
<body>

<header>
  <h1 id="player-name-header">Combine Results</h1>
</header>

<div id="add-combine">
  <input type="number" step="0.01" id="forty_yard" placeholder="40 Yard" />
  <input type="number" id="bench_reps" placeholder="Bench Reps" />
  <input type="number" step="0.01" id="vertical" placeholder="Vertical" />
  <input type="number" step="0.01" id="broad_jump" placeholder="Broad Jump" />
  <input type="number" step="0.01" id="shuttle" placeholder="Shuttle" />
  <input type="number" step="0.01" id="three_cone" placeholder="3 Cone" />
  <button onclick="addCombine()">Add Combine</button>
  <div id="message"></div>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>40 Yard</th>
      <th>Bench</th>
      <th>Vertical</th>
      <th>Broad</th>
      <th>Shuttle</th>
      <th>3 Cone</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="combine-body"></tbody>
</table>

<div id="update-form">
  <h3>Edit Combine</h3>
  <input type="number" step="0.01" id="edit-forty_yard" placeholder="40 Yard" />
  <input type="number" id="edit-bench_reps" placeholder="Bench Reps" />
  <input type="number" step="0.01" id="edit-vertical" placeholder="Vertical" />
  <input type="number" step="0.01" id="edit-broad_jump" placeholder="Broad Jump" />
  <input type="number" step="0.01" id="edit-shuttle" placeholder="Shuttle" />
  <input type="number" step="0.01" id="edit-three_cone" placeholder="3 Cone" />
  <button onclick="submitUpdate()">Save</button>
  <button onclick="cancelUpdate()">Cancel</button>
</div>

<script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const messageEl = document.getElementById("message");
  let combineCache = [];
  let editingId = null;
  const playerId = new URLSearchParams(window.location.search).get('player_id');

  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) window.location.href = "login.html";
  }

  async function loadPlayerName() {
    const { data, error } = await supabase.from('players').select('name').eq('id', playerId).single();
    if (error) return messageEl.textContent = error.message;
    document.getElementById('player-name-header').textContent = data.name + ' Combine Results';
  }

  async function loadCombine() {
    const { data, error } = await supabase.from('combine_results')
      .select('*')
      .eq('player_id', playerId)
      .order('id', { ascending: true });
    if (error) return messageEl.textContent = error.message;

    combineCache = data;
    const tbody = document.getElementById("combine-body");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.id}</td>
        <td>${row.forty_yard}</td>
        <td>${row.bench_reps}</td>
        <td>${row.vertical}</td>
        <td>${row.broad_jump}</td>
        <td>${row.shuttle}</td>
        <td>${row.three_cone}</td>
        <td>
          <button class="update-btn" onclick="editCombine(${row.id})">Edit</button>
          <button class="delete-btn" onclick="deleteCombine(${row.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function addCombine() {
    const payload = {
      player_id: playerId,
      forty_yard: parseFloat(document.getElementById('forty_yard').value) || null,
      bench_reps: parseInt(document.getElementById('bench_reps').value) || null,
      vertical: parseFloat(document.getElementById('vertical').value) || null,
      broad_jump: parseFloat(document.getElementById('broad_jump').value) || null,
      shuttle: parseFloat(document.getElementById('shuttle').value) || null,
      three_cone: parseFloat(document.getElementById('three_cone').value) || null
    };

    const { error } = await supabase.from('combine_results').insert([payload]);
    if (error) messageEl.textContent = error.message;
    else {
      ['forty_yard','bench_reps','vertical','broad_jump','shuttle','three_cone'].forEach(id => document.getElementById(id).value = '');
      messageEl.textContent = '';
      loadCombine();
    }
  }

  function editCombine(id) {
    editingId = id;
    const row = combineCache.find(r => r.id === id);
    document.getElementById('edit-forty_yard').value = row.forty_yard || '';
    document.getElementById('edit-bench_reps').value = row.bench_reps || '';
    document.getElementById('edit-vertical').value = row.vertical || '';
    document.getElementById('edit-broad_jump').value = row.broad_jump || '';
    document.getElementById('edit-shuttle').value = row.shuttle || '';
    document.getElementById('edit-three_cone').value = row.three_cone || '';
    document.getElementById('update-form').style.display = "block";
    window.scrollTo(0, document.body.scrollHeight);
  }

  function cancelUpdate() {
    editingId = null;
    document.getElementById('update-form').style.display = "none";
  }

  async function submitUpdate() {
    if (!editingId) return;
    const payload = {
      forty_yard: parseFloat(document.getElementById('edit-forty_yard').value) || null,
      bench_reps: parseInt(document.getElementById('edit-bench_reps').value) || null,
      vertical: parseFloat(document.getElementById('edit-vertical').value) || null,
      broad_jump: parseFloat(document.getElementById('edit-broad_jump').value) || null,
      shuttle: parseFloat(document.getElementById('edit-shuttle').value) || null,
      three_cone: parseFloat(document.getElementById('edit-three_cone').value) || null
    };

    const { error } = await supabase.from('combine_results').update(payload).eq('id', editingId);
    if (error) alert(error.message);
    else {
      cancelUpdate();
      loadCombine();
    }
  }

  async function deleteCombine(id) {
    if (!confirm("Delete this combine result?")) return;
    const { error } = await supabase.from('combine_results').delete().eq('id', id);
    if (error) alert(error.message);
    else loadCombine();
  }

  window.addCombine = addCombine;
  window.editCombine = editCombine;
  window.cancelUpdate = cancelUpdate;
  window.submitUpdate = submitUpdate;
  window.deleteCombine = deleteCombine;

  checkAuth().then(() => {
    loadPlayerName();
    loadCombine();
  });
</script>

</body>
</html>
